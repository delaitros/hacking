<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Introducción al hacking</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #e2e8f0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem;
      color: #1a202c;
    }
    .container {
      background-color: #ffffff;
      border-radius: 1.5rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
      padding: 2rem;
      width: 100%;
      max-width: 64rem; /* 4xl */
      display: flex;
      flex-direction: column;
      gap: 2rem;
      animation: fadeIn 1s ease-in-out;
    }
    .section-title { font-size: 1.5rem; font-weight: 700; color: #2d3748; margin-bottom: 1rem; }
    .input-group { display: flex; flex-direction: column; gap: .5rem; }
    .input-field {
      padding: .75rem; border-radius: .5rem; border: 1px solid #cbd5e0; width: 100%; transition: .2s;
    }
    .input-field:focus { outline: none; border-color: #4c51bf; box-shadow: 0 0 0 2px rgba(76,81,191,.2); }
    .btn {
      padding: .75rem 1.5rem; border-radius: .75rem; font-weight: 600; transition: .2s; cursor: pointer;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); text-align: center;
    }
    .btn-primary { background-color: #4c51bf; color: #fff; }
    .btn-primary:hover { background-color: #434190; transform: translateY(-2px); }
    .btn-secondary { background-color: #e2e8f0; color: #2d3748; }
    .btn-secondary:hover { background-color: #cbd5e0; transform: translateY(-2px); }
    .btn-green { background-color: #48bb78; color:#fff; }
    .btn-red { background-color: #f56565; color:#fff; }
    .btn-option {
      width: 100%; margin-bottom: .5rem; padding: 1rem; border-radius: .75rem; background-color:#f7fafc;
      border:1px solid #cbd5e0; cursor:pointer; transition:.2s;
    }
    .btn-option:hover { background:#edf2f7; }
    .btn-whatsapp { background:#25d366; color:#fff; }
    .btn-whatsapp:hover { background:#128c7e; transform: translateY(-2px); }
    .message-box {
      padding:1rem; border-radius:.75rem; margin-top:1rem; text-align:center; font-weight:600;
      box-shadow:0 4px 6px -1px rgba(0,0,0,.1); animation: popIn .5s cubic-bezier(.68,-.55,.27,1.55);
    }
    .message-box.incorrect { background:#fbd6d6; color:#c53030; }
    .disabled { opacity:.6; pointer-events:none; }
    #question-area { animation: fadeIn 1s ease-in-out; }

    #correct-animation-overlay, #incorrect-animation-overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      display:flex; justify-content:center; align-items:center; z-index:1000;
      opacity:0; pointer-events:none; transition: opacity .5s ease-in-out;
    }
    #correct-animation-overlay { background-color: rgba(76,175,80,.9); }
    #incorrect-animation-overlay { background-color: rgba(220,38,38,.9); }
    #correct-animation-overlay.show, #incorrect-animation-overlay.show { opacity:1; pointer-events:auto; }
    #correct-animation-message, #incorrect-animation-message {
      font-size:3rem; font-weight:bold; color:#fff; animation: zoomIn .5s ease-out;
    }

    @keyframes popIn { 0% { transform: scale(.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    @keyframes fadeIn { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
    @keyframes zoomIn { 0% { transform: scale(.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-3xl font-bold text-center text-gray-800">Aplicación de Preguntas</h1>
    <div class="flex flex-col md:flex-row gap-4">
      <!-- Sección del quiz para los alumnos -->
      <div id="student-section" class="bg-gray-50 p-6 rounded-2xl flex-1">
        <h2 class="section-title">Introducción al hacking, 6to año 724</h2>

        <div class="input-group mb-4">
          <label for="student-name" class="font-semibold text-gray-700">Tu Nombre:</label>
          <input type="text" id="student-name" class="input-field" placeholder="Escribe tu nombre">
        </div>

        <div id="question-area" class="text-center">
          <p id="question-display" class="text-lg font-semibold text-gray-800 mb-4">Cargando preguntas...</p>

          <div id="answer-input-container" class="flex flex-col items-center gap-2" style="display: none;">
            <input type="text" id="answer-input" class="input-field max-w-lg" placeholder="Escribe tu respuesta aquí...">
            <button id="submit-answer-btn" class="btn btn-primary">Verificar Respuesta</button>
          </div>

          <div id="student-message-container"></div>

          <div class="flex flex-col md:flex-row gap-2 mt-4">
            <button id="next-question-btn" class="btn btn-secondary flex-1 disabled">Siguiente Pregunta</button>
            <button id="hint-btn" class="btn btn-whatsapp flex-1 disabled">💡 Pedir Pista (WhatsApp)</button>
          </div>
        </div>

        <div class="mt-8 pt-4 border-t border-gray-200 text-center">
          <h2 class="section-title">Puntuación</h2>
          <p id="score-display" class="text-2xl font-bold text-gray-800">0 puntos</p>
          <button id="reset-btn" class="btn btn-red w-full mt-4">Reiniciar Quiz</button>
          <button id="music-toggle-btn" class="btn btn-secondary w-full mt-4">🎵 Pausar Música</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay de animación para respuesta correcta -->
  <div id="correct-animation-overlay">
    <div id="correct-animation-message">¡Respuesta Correcta!</div>
  </div>

  <!-- Overlay de animación para respuesta incorrecta -->
  <div id="incorrect-animation-overlay">
    <div id="incorrect-animation-message">¡Respuesta Incorrecta!</div>
  </div>

  <!-- Música de fondo -->
  <audio id="background-music" loop>
    <source src="https://www.bensound.com/bensound-music/bensound-jazzyfrenchy.mp3" type="audio/mpeg">
    Tu navegador no soporta el elemento de audio.
  </audio>

  <!-- Sonidos -->
  <audio id="correct-sound">
    <source src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/3/correct.mp3" type="audio/mpeg">
  </audio>
  <audio id="incorrect-sound">
    <source src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/3/incorrect.mp3" type="audio/mpeg">
  </audio>

  <script>
    function playCorrect(){ const a=document.getElementById('correct-sound'); a.volume=1; a.currentTime=0; a.play(); }
    function playIncorrect(){ const a=document.getElementById('incorrect-sound'); a.volume=1; a.currentTime=0; a.play(); }
  </script>

  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    setLogLevel('debug');

    const firebaseConfig = {
      apiKey: "AIzaSyCe6IZxXWbV4oh5omAEQ1q5vOiJ_Zt2k3A",
      authDomain: "quizz-sexto.firebaseapp.com",
      projectId: "quizz-sexto",
      storageBucket: "quizz-sexto.firebasestorage.app",
      messagingSenderId: "538951385566",
      appId: "1:538951385566:web:f24284c89cd67b6c4bdd4f",
      measurementId: "G-PDVXLXYHQ9"
    };

    const appId = firebaseConfig.projectId;

    let app, db, auth, userId;
    let questions = [];
    let currentQuestionIndex = 0;
    let score = { points: 0, questionsAnswered: 0 };
    let currentQuestionAttempts = 0;

    const teacherPhone = '+5492804292040';

    // DOM
    const studentNameEl = document.getElementById('student-name');
    const questionDisplay = document.getElementById('question-display');
    const answerInput = document.getElementById('answer-input');
    const submitAnswerBtn = document.getElementById('submit-answer-btn');
    const studentMessageContainer = document.getElementById('student-message-container');
    const scoreDisplay = document.getElementById('score-display');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const hintBtn = document.getElementById('hint-btn');
    const resetBtn = document.getElementById('reset-btn');
    const backgroundMusic = document.getElementById('background-music');
    const musicToggleBtn = document.getElementById('music-toggle-btn');
    const correctSound = document.getElementById('correct-sound');
    const incorrectSound = document.getElementById('incorrect-sound');
    const correctAnimationOverlay = document.getElementById('correct-animation-overlay');
    const incorrectAnimationOverlay = document.getElementById('incorrect-animation-overlay');
    const answerInputContainer = document.getElementById('answer-input-container');

    // Habilitar audio tras primera interacción
    document.addEventListener('DOMContentLoaded', () => {
      document.body.addEventListener('click', () => {
        if (backgroundMusic.paused) {
          backgroundMusic.play().catch(e => console.error('Error al reproducir la música de fondo:', e));
        }
      }, { once: true });
    });

    // === Cargar preguntas exactamente como en tu ejemplo (colección 'quiz_questions') ===
    async function fetchQuestions() {
      try {
        if (!db) {
          console.error("Firestore no está inicializado. No se pueden cargar las preguntas.");
          questionDisplay.textContent = 'Error: No se pueden cargar las preguntas. Por favor, reinicia la aplicación.';
          return;
        }

        // Lee la colección directamente desde la raíz, sin ordenar
        const querySnapshot = await getDocs(collection(db, 'quiz_questions'));

        if (querySnapshot.empty) {
          questionDisplay.textContent = 'No hay preguntas disponibles. Por favor, añade preguntas a la base de datos.';
          answerInputContainer.style.display = 'none';
          return;
        }

        questions = querySnapshot.docs.map(doc => doc.data());
        renderQuestion();
        answerInputContainer.style.display = 'flex';
      } catch (error) {
        console.error("Error al cargar las preguntas: ", error);
        questionDisplay.textContent = 'Error al cargar las preguntas. Revisa la consola para más detalles.';
      }
    }

    function renderQuestion() {
      if (questions.length === 0) {
        questionDisplay.textContent = 'No hay preguntas disponibles.';
        answerInputContainer.style.display = 'none';
        nextQuestionBtn.classList.add('disabled');
        hintBtn.classList.add('disabled');
        return;
      }

      nextQuestionBtn.classList.add('disabled');
      hintBtn.classList.remove('disabled');
      submitAnswerBtn.classList.remove('disabled');
      answerInput.value = '';
      studentMessageContainer.innerHTML = '';
      answerInput.focus();

      const currentQuestion = questions[currentQuestionIndex];
      if (currentQuestion && currentQuestion.question) {
        questionDisplay.textContent = currentQuestion.question;
      } else {
        questionDisplay.textContent = 'Error: No se encontró la pregunta. Por favor, revisa tus datos en Firestore.';
        answerInputContainer.style.display = 'none';
      }
    }

    async function saveQuizResult() {
      try {
        if (!db) {
          console.error("Firestore no está inicializado.");
          return;
        }
        await addDoc(collection(db, `/artifacts/${appId}/public/data/quiz_results`), {
          name: studentNameEl.value || 'Anónimo',
          score_points: score.points,
          totalQuestions: questions.length,
          date: serverTimestamp(),
          userId: userId
        });
      } catch (e) {
        console.error("Error al añadir el documento: ", e);
      }
    }

    function handleAnswer() {
      const userAnswer = answerInput.value.trim().toLowerCase();
      const correctAnswer = (questions[currentQuestionIndex].correctAnswer || '').trim().toLowerCase();

      studentMessageContainer.innerHTML = '';

      if (userAnswer === correctAnswer && correctAnswer.length) {
        try { correctSound.play(); } catch (e) {}
        let pointsForQuestion = 1000;
        for (let i = 0; i < currentQuestionAttempts; i++) pointsForQuestion /= 2;
        score.points += Math.round(pointsForQuestion);
        score.questionsAnswered++;
        currentQuestionAttempts = 0;

        updateScoreDisplay();

        correctAnimationOverlay.classList.add('show');
        setTimeout(() => {
          correctAnimationOverlay.classList.remove('show');
          currentQuestionIndex++;
          if (currentQuestionIndex < questions.length) {
            renderQuestion();
          } else {
            endQuiz();
          }
        }, 2000);
      } else {
        try { incorrectSound.play(); } catch (e) {}
        currentQuestionAttempts++;
        updateScoreDisplay();

        incorrectAnimationOverlay.classList.add('show');
        setTimeout(() => {
          incorrectAnimationOverlay.classList.remove('show');
        }, 1500);
      }
    }

    function endQuiz() {
      saveQuizResult();

      questionDisplay.textContent = '¡Has completado el quiz!';
      answerInputContainer.style.display = 'none';
      nextQuestionBtn.classList.add('disabled');
      hintBtn.classList.add('disabled');
      studentMessageContainer.innerHTML = '';
      const finalScoreMessage = document.createElement('div');
      finalScoreMessage.classList.add('message-box', 'correct');
      finalScoreMessage.textContent = `Puntuación final: ${score.points} puntos`;
      studentMessageContainer.appendChild(finalScoreMessage);

      const studentName = studentNameEl.value.trim() || 'Un alumno anónimo';
      const message = `¡Hola! ${studentName} ha completado el quiz "Introducción al hacking" con una puntuación de ${score.points} puntos.`;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${teacherPhone}?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');
    }

    function updateScoreDisplay() {
      scoreDisplay.textContent = `${score.points} puntos`;
    }

    // Eventos
    submitAnswerBtn.addEventListener('click', handleAnswer);
    answerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); handleAnswer(); }
    });

    nextQuestionBtn.addEventListener('click', () => {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        renderQuestion();
      } else {
        endQuiz();
      }
    });

    hintBtn.addEventListener('click', () => {
      const studentName = studentNameEl.value.trim();
      const currentQuestion = questions[currentQuestionIndex];

      if (!studentName) {
        studentMessageContainer.innerHTML = `<div class="message-box incorrect">Por favor, ingresa tu nombre para pedir ayuda.</div>`;
        return;
      }

      const message = `Hola, soy ${studentName} y necesito una pista con esta pregunta: "${currentQuestion.question}"`;
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${teacherPhone}?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');

      const hintMessage = document.createElement('div');
      hintMessage.classList.add('message-box', 'correct');
      hintMessage.textContent = '¡Pista enviada! Revisa tu WhatsApp.';
      studentMessageContainer.innerHTML = '';
      studentMessageContainer.appendChild(hintMessage);
    });

    resetBtn.addEventListener('click', () => {
      currentQuestionIndex = 0;
      score = { points: 0, questionsAnswered: 0 };
      currentQuestionAttempts = 0;
      updateScoreDisplay();
      answerInputContainer.style.display = 'flex';
      fetchQuestions();
    });

    musicToggleBtn.addEventListener('click', () => {
      if (backgroundMusic.paused) {
        backgroundMusic.play();
        musicToggleBtn.textContent = '🎵 Pausar Música';
      } else {
        backgroundMusic.pause();
        musicToggleBtn.textContent = '▶️ Reproducir Música';
      }
    });

    // Init
    window.onload = async () => {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);

      try {
        const userCredential = await signInAnonymously(auth);
        userId = userCredential.user.uid;
        console.log("Autenticación exitosa como usuario anónimo.");
        fetchQuestions();
      } catch (error) {
        console.error("Error de autenticación: ", error);
      }

      backgroundMusic.play().catch(() => {
        musicToggleBtn.textContent = '▶️ Reproducir Música';
      });
    };
  </script>
</body>
</html>

